services:
  rethinkdb:
    image: rethinkdb:2.4
    restart: unless-stopped
    command: rethinkdb --bind all --cache-size 256
    healthcheck:
      test: ["CMD", "true"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - rethinkdb-data:/data
    networks:
      - isleward

  isleward-server:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      IWD_PORT: 5000
      IWD_DB: rethink
      IWD_DB_HOST: rethinkdb
      IWD_DB_PORT: 28015
      IWD_DB_NAME: ${IWD_DB_NAME:-live}
      IWD_DB_USER: ${IWD_DB_USER:-admin}
      IWD_DB_PASS: ${IWD_DB_PASS:-}
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:5000/rest/info').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
    depends_on:
      - rethinkdb
    networks:
      - isleward

  isleward-client:
    build:
      context: .
      dockerfile: Dockerfile.client
    restart: unless-stopped
    depends_on:
      - isleward-server
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/rest/info >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - isleward
    labels:
      - traefik.enable=true
      - traefik.docker.network=coolify
      - traefik.http.routers.isleward-client.rule=Host(`${ISLEWARD_DOMAIN}`)
      - traefik.http.routers.isleward-client.entrypoints=https
      - traefik.http.routers.isleward-client.tls.certresolver=letsencrypt
      - traefik.http.routers.isleward-client.service=isleward-client-svc
      - traefik.http.services.isleward-client-svc.loadbalancer.server.port=80

volumes:
  rethinkdb-data:

networks:
  isleward:
    name: isleward
